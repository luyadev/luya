# JWT auth with SPA Applications

> since LUYA admin module version 2.2

The LUYA admin provides a basic JWT generator including an out of the box authentification system which can proxy requests trough LUYA Admin Api User and those permission system.

## Prerequisite

+ A custom (application) admin module is required to setup JWT ([[app-admin-module.md]]).
+ Understand Api Users which are explaind in Headless Guide Section ([[concept-headless.md]]).
+ Configure the {{luya\admin\components\Jwt}} component.

## How it works

As all LUYA admin APIs requerd an authentification are proxied trough LUYA API Users (Read about [[concept.headless.md]]).

The life cycle of the JWT request is described as followed (assuming jwt configuration in the modul is done accordingly):

Get the token:

+ A token is generated by a not secured action, the {{luya\admin\components\Jwt::generateToken()}} is a helper to generate the token.
+ Make a request to any LUYA Admin API:

Make Request:

+ The Authentification system will threat JWT auth first.
+ Token will be passed to the {{luya\admin\baseJwtIdentityInterface::loginByJwtToken()}} method. Return the user if login is valid.
+ The Api User model defined in {{luya\admin\components\Jwt::$apiUserEmail}} will be looked up and loggedin.
+ The authenticated Api User check permission based on the related groups (Api Users can associated with multiple groups or none).

The image shows the above descriped cycle.

![luya-proxy](https://raw.githubusercontent.com/luyadev/luya/master/docs/guide/img/jwt-apiuser-proxy.png "JWT with Admin as Proxy")

## Setup

1. Configure the {{luya\admin\components\Jwt}} component in your config:

```php
'components' => [
    'jwt' => [
        'class' => 'luya\admin\components\Jwt',
        'key' => 'MySecretJwtKey',
        'apiUserEmail' => 'jwtapiuser@luya.io',
        'identityClass' => 'app\modules\myadminmodule\models\User',
    ],
],
```

2. Implement the {{luya\admin\base\JwtIdentityInterface}} into the given {{luya\admin\components\Jwt::$identityClass}}.
3. Generate an Action for Login (generate token) and signup (if needed).
4. Setup the defined {{luya\admin\components\Jwt::$apiUserEmail}} Api User and grant the needed permissions (none if no admin resources should be accessible).

The User which contains user data:

```php

class User extends \luya\admin\ngrest\base\NgRestModel implements luya\admin\base\JwtIdentityInterface
{
    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return '{{%user}}';
    }

    /**
     * @inheritdoc
     */
    public static function ngRestApiEndpoint()
    {
        return 'api-user';
    }

    // ....... other ngrest models specific content ........... //

    /* JwtIdentityInterface */

    public function getId()
    {
        return $this->id;
    }

    public static function loginByJwtToken(\Lcobucci\JWT\Token $token)
    {
        return self::findOne(['jwtToken' => $token->__toString()]);
    }
}
```

An NgRest Api with additonal login, signup and me actions.

```php
/**
 * User Controller.
 * 
 * The example assumes that app\modules\myapimodule\models\User implements the luya\admin\base\JwtIdentityInterface
 */
class UserController extends \luya\admin\ngrest\base\Api
{
    /**
     * @var array Define methods which does not require authentification
     */
    public $authOptional = ['login', 'signup'];

    /**
     * @var string The path to the model which is the provider for the rules and fields.
     */
    public $modelClass = 'app\modules\myapimodule\models\User';

    /**
     * Make user login and return the user with the fresh generated jwt token which is stored in the user.
     * 
     * > No authentification needed.
     */
    public function actionLogin()
    {
        $model = new User();
        $model->scenario = User::SCENARIO_LOGIN;
        if ($model->load(Yii::$app->request->post(), '') && $model->validate()) {
            $user = User::find()->where(['email' => $model->email])->one();
            if ($user && Yii::$app->security->validatePassword($model->password, $user->password)) {
                if ($user->updateAttributes(['jwtToken' => Yii::$app->jwt->generateToken($user)])) {
                    return $user;
                }
        
            } else {
                $model->addError('email', 'Unable to find the given email or password is wrong.');
            }
        }

        return $this->sendModelError($model);
    }

    /**
     * Allow users to signup which will create a new user.
     * 
     * > No authentification needed.
     *
     * @return User
     */
    public function actionSignup()
    {
        $model = new User();
        if ($model->load(Yii::$app->request->post(), '') && $model->save()) {
            return $model;
        }

        return $this->sendModelError($model);
    }

    /**
     * Returns the currently logged in jwt authenticated user.
     *
     * > This method requires authentification.
     * 
     * @return User
     */
    public function actionMe()
    {
        return Yii::$app->jwt->identity;
    }
}
```

If a successfull jwt authentication is made the {{luya\admin\components\Jwt::$identity}} contains the {{luya\admin\components\Jwt::$identityClass}} object implementing {{luya\admin\base\JwtIdentityInterface}}.

## Permissions

A few principals regarding permissions:

+ Unless an action is masked as {{luya\traits\RestBehaviorsTrait::$authOptional}} **every action requires authentification**.
+ If the group of the defined {{luya\admin\components\Jwt::$apiUserEmail}} API user has **no permissions**, only your custom actions are accessible.
+ When accessing NgRest API actions like update, create, list or view (detail) and permission is granted the actions are logged with the configured ApiUser.
+ As permission is proxied trough Api Users, a valid Api User token could access those informations as well.